# 恢复会话上下文

从 Claude Code 自动保存的 JSONL 文件中恢复对话上下文。

## 第一步：列出可恢复的会话

**必须执行以下命令**来列出当前项目的可恢复会话：

```bash
python3 ~/.claude/scripts/session-indexer.py --auto
```

**重要**：直接展示脚本输出的完整表格给用户，不要做二次总结或简化。

## 第二步：等待用户选择

展示完整表格后，用户可以输入以下内容：

### 恢复会话
- 输入 **序号**（如 `3`）- 恢复指定序号的会话
- 输入 **latest** - 恢复最新的会话（序号 1）
- 输入 **文件名**（如 `da384202-xxx.jsonl`）- 恢复指定文件

### 查看更多会话
- 输入 **more** - 显示前 30 个会话
- 输入 **more 50** - 显示前 50 个会话
- 输入 **more all** - 显示全部会话

对应执行的命令：
```bash
python3 ~/.claude/scripts/session-indexer.py --auto -l 30
python3 ~/.claude/scripts/session-indexer.py --auto -l 50
python3 ~/.claude/scripts/session-indexer.py --auto -l 0
```

### 搜索会话
- 输入 **search 关键词** - 搜索匹配的会话

对应执行的命令：
```bash
python3 ~/.claude/scripts/session-indexer.py --auto -s "关键词"
```

搜索支持匹配：
- 主要内容（标题）
- 标签（如 `search React`、`search 错误处理`）
- 日期（如 `search 12-30`）
- 文件名（session_id）

## 第三步：分析和恢复

读取选定的 JSONL 文件，提取：
- 用户的原始需求
- 已完成的任务
- 重要的技术决策
- 未完成的工作

生成结构化的恢复摘要并加载到当前会话。

## 表格字段说明

| 字段 | 说明 |
|------|------|
| 序号 | 用于快速选择的序号 |
| 文件名 | 完整的 JSONL 文件名（session_id.jsonl） |
| 修改时间 | 会话最后修改时间 |
| 主要内容 | 会话标题（从命令名称、提示词或用户消息提取） |
| 标签 | 自动生成的技术标签（最多 3 个，4字中文） |
| 大小 | 文件大小，⭐ 表示大于 1MB |

## 标题提取策略

会话标题按以下优先级提取：
1. **命令名称**：如 `/recover-context` → "恢复会话上下文"
2. **提示词标题**：如 `# 项目架构分析` → "项目架构分析"
3. **用户消息**：第一条有意义的用户请求
4. **默认**：如果都没有，显示"无标题会话"

## 注意事项

1. **不要简化或重新格式化脚本输出的表格**，直接展示给用户
2. 默认显示前 10 个会话
3. `agent-*.jsonl` 是子代理文件，已自动过滤
4. 需要先运行 `./scripts/hooks/install-hooks.sh` 安装会话索引器
